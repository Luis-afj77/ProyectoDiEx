---
title: " Proyecto equipo 4 "
output: html_notebook
---

```{r}
#Librerias
library(pwr)
library(ggplot2)
library(dplyr)
library(fitdistrplus)
```



# Comenzando a obtener los datos de nuestros sujetos:
```{r}
##Linea Base

# obtenemos toda la base de datos de epilepsia
data_cruda<-MASS::epil
data_cruda

# Quitar los outliers

#buscamos donde estan los outliers, sujetos 49 y 25
data_cruda
which(data_cruda$subject == 25)

#borramos las filas correspondientes y asignamos nuevo nombre

data_cruda_out <- data_cruda[-c(97, 98, 99, 100, 193, 194, 195, 196),]
data_cruda_out

# data cocinada (línea base/4)
Data_cocinada <- data.frame(data_cruda$subject, data_cruda$base /4, data_cruda$y, data_cruda$period, data_cruda$trt)
#cambiando nombres
colnames(Data_cocinada)
names(Data_cocinada)[names(Data_cocinada) == "data_cruda.subject"] <- "sujeto"
names(Data_cocinada)[names(Data_cocinada) == "data_cruda.base.4"] <- "base"
names(Data_cocinada)[names(Data_cocinada) == "data_cruda.y"] <- "crisis"
names(Data_cocinada)[names(Data_cocinada) == "data_cruda.period"] <- "periodo"
names(Data_cocinada)[names(Data_cocinada) == "data_cruda.trt"] <- "tratamiento"
Data_cocinada
# data sin linea base
Data_condimentada <- data.frame(Data_cocinada$sujeto, Data_cocinada$crisis, Data_cocinada$periodo, Data_cocinada$tratamiento)
names(Data_condimentada)[names(Data_condimentada) == "Data_cocinada.sujeto"] <- "sujeto"
names(Data_condimentada)[names(Data_condimentada) == "Data_cocinada.crisis"] <- "crisis"
names(Data_condimentada)[names(Data_condimentada) == "Data_cocinada.periodo"] <- "periodo"
names(Data_condimentada)[names(Data_condimentada) == "Data_cocinada.tratamiento"] <- "tratamiento"
colnames(Data_condimentada)
# Poniendo la línea base como periodo 0
period0 <- data.frame(sujeto= Data_cocinada$sujeto, crisis= Data_cocinada$base, periodo = 0, tratamiento = Data_cocinada$tratamiento)

period0$periodo <- as.factor(period0$periodo)
period0_ND <- period0 %>% distinct

Data_condimentada <- rbind(Data_condimentada, period0_ND)

Data_condimentada
Data_condimentada <- Data_condimentada[with(Data_condimentada, order(Data_condimentada$sujeto)), ]
#Con este data.frame ya podemos hacer nuestras pruebas de hipotesis.
```

# Base de datos de porcentaje de diferencia:
```{r}
# Añadiendo el porcetaje de diferencia
Porcentaje.diferencia <- (Data_cocinada$crisis / Data_cocinada$base)*100
Porcentaje.diferencia 
Porcentaje.df <- cbind(Data_cocinada, Porcentaje.diferencia)
names(Porcentaje.df)[names(Porcentaje.df) == "Porcentaje.diferencia"] <- "porcentaje"
names(Porcentaje.df)[names(Porcentaje.df) == "data_cruda.trt"] <- "tratamiento"
Porcentaje.df$periodo <- as.factor(Porcentaje.df$periodo)
```
# Análisis descriptivo:
## De la edad de los pacientes
```{r}
Data_condimentada

median()
mean()
mode()

```


# Boxplots:
```{r}
boxplots_cruda <- ggplot(Data_condimentada, aes(x= periodo, y= crisis, fill= tratamiento)) +
  geom_boxplot() +
  ggtitle("Número de crisis epilépticas de los sujetos por cada periodo")
boxplots_cruda

boxplots_porcentaje <- ggplot(Porcentaje.df, aes(x= periodo, y= porcentaje, fill= tratamiento)) +
  geom_boxplot() +
ggtitle("Porcentaje de crisis epilépticas por periodo con respecto a línea base")
boxplots_porcentaje
```

# Prueba wilcoxon datos crudos
```{r}
#Aqui no diferencia a los periodos, por lo que  comparamos entre placebo y progabide sin la base ya que la linea base sirve para comparar.
pairwise.wilcox.test(x=as.numeric(Data_cocinada$crisis), g=as.factor(Data_cocinada$tratamiento),
                     p.adjust.method = "bonferroni",paired = FALSE)

#A1 de Alan.doc
Data_wilcoxon <- Data_condimentada

#Periodo + tratamiento en una sola columna
Data_wilcoxon$Vector1<-paste0(Data_wilcoxon$tratamiento, Data_wilcoxon$periodo)

pairwise.wilcox.test(x=as.numeric(Data_wilcoxon$crisis), g=as.factor(Data_wilcoxon$Vector1),
                     p.adjust.method = "bonferroni",paired = FALSE, exact=FALSE)

#optimización
i=0
while (i < 5) {
pl= paste0("placebo",i)
pr= paste0("progabide",i)
w <- wilcox.test(Data_wilcoxon$crisis[Data_wilcoxon$Vector1 ==pl], Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == pr], paired = FALSE, alternative = "greater",exact=FALSE)
  i= i+1
print(paste0("grupo",i))
print(w)
}

```

# Medias
```{r}
resumen <- function(data, varname, groupnames){
  resumen_funcion <- function(x, col){
    c(mean = mean(x[[col]], na.rm=TRUE),
      sd = sd(x[[col]], na.rm=TRUE))
  }
  data_sum<-ddply(data, groupnames, .fun=resumen_funcion,
                  varname)
  data_sum <- rename(data_sum, c("mean" = varname))
 return(data_sum)
}


resumen.df <- resumen(Porcentaje.df, varname = "porcentaje", groupnames=c("tratamiento", "periodo"))
resumen.df
# Convert dose to a factor variable
resumen.df$porcentaje=as.factor(resumen.df$porcentaje)

# grafica de medias con desviacion
medias <- ggplot(resumen.df, aes(x=periodo, y=porcentaje, group= tratamiento, color=tratamiento)) + 
  geom_line() +
  geom_point()+
  geom_errorbar(aes(ymin=porcentaje-sd, ymax=porcentaje+sd), width=.2,
                 position=position_dodge(0.05))
medias
```

# Realizamos lo mismo con el grupo control

# Nos quedamos solo con los datos de aquellos con placebo 
sujetos_placebo<-subset(data_cruda, trt == "placebo")
sujetos_placebo$y
# como cada sujeto tiene 4 medidas en y, obtengo diviendo entre 4 la cantidad de sujetos.
num_sujetospl<-(length(sujetos_placebo$trt)/4)
# obtener la linea base con identificador de paciente
linea_base_p <- data.frame(sujetos_placebo$base,sujetos_placebo$age,sujetos_placebo$subject)
# eliminamos los valores repetidos (ya que como se tiene 4 medidas pero la base es la misma e igual el identificador del sujeto)
linea_base_p[duplicated(linea_base_p), ]
#Con esto cambio los nombres.
control0 <- rename(linea_base_p %>% distinct, base = "sujetos_placebo.base" , edad="sujetos_placebo.age",sujeto= "sujetos_placebo.subject")

## Control 1,2,3,4 (las semanas)

sujetos_placebo1 <- subset(sujetos_placebo, period == "1")
control1 <- data.frame(sujetos_placebo1$y,sujetos_placebo1$age,sujetos_placebo1$subject)
control1 <- rename(control1 %>% distinct, crisis1 = "sujetos_placebo1.y" , edad="sujetos_placebo1.age",sujeto= "sujetos_placebo1.subject")

sujetos_placebo2 <- subset(sujetos_placebo, period == "2")
control2 <- data.frame(sujetos_placebo2$y,sujetos_placebo2$age,sujetos_placebo2$subject)
control2 <- rename(control2 %>% distinct, crisis2 = "sujetos_placebo2.y" , edad="sujetos_placebo2.age",sujeto= "sujetos_placebo2.subject")

sujetos_placebo3 <- subset(sujetos_placebo, period == "3")
control3 <- data.frame(sujetos_placebo3$y,sujetos_placebo3$age,sujetos_placebo3$subject)
control3 <- rename(control3 %>% distinct, crisis3 = "sujetos_placebo3.y" , edad="sujetos_placebo3.age",sujeto= "sujetos_placebo3.subject")

sujetos_placebo4 <- subset(sujetos_placebo, period == "4")
control4 <- data.frame(sujetos_placebo4$y,sujetos_placebo4$age,sujetos_placebo4$subject)
control4 <- rename(control4 %>% distinct, crisis4 = "sujetos_placebo4.y" , edad="sujetos_placebo4.age",sujeto= "sujetos_placebo4.subject")
controles <- data.frame(control0,control1,control2,control3,control4)


## Ver las distribuciones en cada control (boxplots)

boxplotsc.df <- data.frame(sujetos_placebo$y, sujetos_placebo$period)
colnames(boxplotsc.df)

names(boxplotsc.df)[names(boxplotsc.df) == "sujetos_placebo.y"] <- "crisis"
names(boxplotsc.df)[names(boxplotsc.df) == "sujetos_placebo.period"] <- "periodo"

p0 <- data.frame(crisis= sujetos_placebo$base / 4, periodo = 0)

boxplotsc.df <- rbind(boxplotsc.df, p0)
boxplotsc.df$periodo <- as.factor(boxplotsc.df$periodo)

bpcontrol <- ggplot(boxplotsc.df, aes(x= periodo, y= crisis, color=periodo)) +
  geom_boxplot()
bpcontrol


# Gráfica de cómo va avanzando cada control

sujetos.control <- data.frame(sujetos_placebo$subject, sujetos_placebo$y, sujetos_placebo$period)

names(sujetos.control)[names(sujetos.control) == "sujetos_placebo.y"] <- "crisis"
names(sujetos.control)[names(sujetos.control) == "sujetos_placebo.period"] <- "periodo"
names(sujetos.control)[names(sujetos.control) == "sujetos_placebo.subject"] <- "sujetos"

p0.c <- data.frame(sujetos = sujetos_placebo$subject, crisis= sujetos_placebo$base, periodo = 0 )

sujetos.control <- rbind(sujetos.control, p0.c)
sujetos.control$periodo <- as.factor(sujetos.control$periodo)
sujetos.control$sujetos <- as.factor(sujetos.control$sujetos)
View(sujetos.control)

indcontrol <- ggplot(sujetos.control, aes(x = periodo, y = crisis, color = sujetos, group = sujetos)) + geom_point() + geom_line()
indcontrol

## Pruebas estadisticas de linea base para observar que tipo de distribucion es

shapiro.test(control0$base)
#puedo rechazar la hipotesis nula
#no es normal nuestra distribución
hist(log10(control0$base)) #no es recomendable para ver mejor si hay outlayers.
hist(control0$base)
#Q-Q plot para verificar si es normal
qqnorm(control0$base)
qqline(control0$base, col="purple", lw=2) #se ve que no es normal

library(fitdistrplus)
descdist(control0$base) # también se ve como una distribución beta


## Observando estadistica descriptiva de grupos de las semanas:

summary(controles) #tendríamos que cambiar los sujetos a factores

controles$sujeto <- as.factor(controles$sujeto)
controles$sujeto.1 <- as.factor(controles$sujeto.1)
controles$sujeto.2 <- as.factor(controles$sujeto.2)
controles$sujeto.3 <- as.factor(controles$sujeto.3)
controles$sujeto.4 <- as.factor(controles$sujeto.4)

summary(controles) # listo :)

# PRUEBAS DE NORMALIDAD

## Control 1
shapiro.test(control1$crisis1) # se rechaza hipótesis nula, no es normal la distribución 
hist(control1$crisis1)
library(fitdistrplus)
descdist(control1$crisis1) # se ve que también es beta

## Control 2
shapiro.test(control2$crisis2) # se rechaza hipótesis nula, no es normal la distribución 
hist(control2$crisis2)
library(fitdistrplus)
descdist(control2$crisis2)# se ve que también es beta

## Control 3
shapiro.test(control3$crisis3) # se rechaza hipótesis nula, no es normal la distribución 
hist(control3$crisis3)
library(fitdistrplus)
descdist(control3$crisis3)# se ve que también es beta

## Control 4
shapiro.test(control4$crisis4) # se rechaza hipótesis nula, no es normal la distribución 
hist(control4$crisis4)
library(fitdistrplus)
descdist(control4$crisis4)# se ve que también es beta

## Uno por uno wilcoxon
wilcox.test(Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "placebo0"], Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "progabide0"], paired = FALSE, alternative = "greater")
wilcox.test(Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "placebo0"], Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "progabide1"], paired = FALSE, alternative = "greater")
wilcox.test(Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "placebo0"], Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "progabide2"], paired = FALSE, alternative = "greater")
wilcox.test(Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "placebo0"], Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "progabide3"], paired = FALSE, alternative = "greater")
wilcox.test(Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "placebo0"], Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "progabide4"], paired = FALSE, alternative = "greater")

wilcox.test(Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "placebo1"], Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "progabide0"], paired = FALSE, alternative = "greater")
wilcox.test(Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "placebo1"], Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "progabide1"], paired = FALSE, alternative = "greater")
wilcox.test(Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "placebo1"], Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "progabide2"], paired = FALSE, alternative = "greater")
wilcox.test(Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "placebo1"], Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "progabide3"], paired = FALSE, alternative = "greater")
wilcox.test(Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "placebo1"], Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "progabide4"], paired = FALSE, alternative = "greater")

wilcox.test(Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "placebo2"], Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "progabide0"], paired = FALSE, alternative = "greater")
wilcox.test(Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "placebo2"], Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "progabide1"], paired = FALSE, alternative = "greater")
wilcox.test(Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "placebo2"], Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "progabide2"], paired = FALSE, alternative = "greater")
wilcox.test(Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "placebo2"], Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "progabide3"], paired = FALSE, alternative = "greater")
wilcox.test(Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "placebo2"], Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "progabide4"], paired = FALSE, alternative = "greater")

wilcox.test(Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "placebo3"], Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "progabide0"], paired = FALSE, alternative = "greater")
wilcox.test(Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "placebo3"], Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "progabide1"], paired = FALSE, alternative = "greater")
wilcox.test(Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "placebo3"], Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "progabide2"], paired = FALSE, alternative = "greater")
wilcox.test(Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "placebo3"], Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "progabide3"], paired = FALSE, alternative = "greater")
wilcox.test(Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "placebo3"], Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "progabide4"], paired = FALSE, alternative = "greater")

wilcox.test(Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "placebo4"], Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "progabide0"], paired = FALSE, alternative = "greater")
wilcox.test(Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "placebo4"], Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "progabide1"], paired = FALSE, alternative = "greater")
wilcox.test(Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "placebo4"], Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "progabide2"], paired = FALSE, alternative = "greater")
wilcox.test(Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "placebo4"], Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "progabide3"], paired = FALSE, alternative = "greater")
wilcox.test(Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "placebo4"], Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "progabide4"], paired = FALSE, alternative = "greater")


wilcox.test(Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "progabide0"], Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "progabide1"], paired = FALSE, alternative = "greater")
wilcox.test(Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "progabide0"], Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "progabide2"], paired = FALSE, alternative = "greater")
wilcox.test(Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "progabide0"], Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "progabide3"], paired = FALSE, alternative = "greater")
wilcox.test(Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "progabide0"], Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "progabide4"], paired = FALSE, alternative = "greater")

wilcox.test(Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "progabide1"], Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "progabide4"], paired = FALSE, alternative = "greater")
wilcox.test(Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "progabide1"], Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "progabide2"], paired = FALSE, alternative = "greater")
wilcox.test(Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "progabide1"], Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "progabide3"], paired = FALSE, alternative = "greater")

wilcox.test(Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "progabide2"], Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "progabide4"], paired = FALSE, alternative = "greater")
wilcox.test(Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "progabide2"], Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "progabide3"], paired = FALSE, alternative = "greater")

wilcox.test(Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "progabide3"], Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "progabide4"], paired = FALSE, alternative = "greater")

wilcox.test(Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "placebo0"], Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "placebo1"], paired = FALSE, alternative = "greater")
wilcox.test(Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "placebo0"], Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "placebo2"], paired = FALSE, alternative = "greater")
wilcox.test(Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "placebo0"], Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "placebo3"], paired = FALSE, alternative = "greater")
wilcox.test(Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "placebo0"], Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "placebo4"], paired = FALSE, alternative = "greater")

wilcox.test(Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "placebo1"], Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "placebo2"], paired = FALSE, alternative = "greater")
wilcox.test(Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "placebo1"], Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "placebo3"], paired = FALSE, alternative = "greater")
wilcox.test(Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "placebo1"], Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "placebo4"], paired = FALSE, alternative = "greater")

wilcox.test(Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "placebo2"], Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "placebo3"], paired = FALSE, alternative = "greater")
wilcox.test(Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "placebo2"], Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "placebo4"], paired = FALSE, alternative = "greater")

wilcox.test(Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "placebo3"], Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "placebo4"], paired = FALSE, alternative = "greater")


















  
