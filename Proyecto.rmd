
```{r}
#Librerias
library(pwr)
library(ggplot2)
library(dplyr)
library(fitdistrplus)
```


```{r}
pwr.anova.test(k=5, n=NULL, f=0.8, sig.level = 0.05, power= 0.8)
#Me arroja que para obtener resultados significativos, almenos necesito 4,78 muestras por grupo, nosotros tenemos 21 por lo que estamos bien.
```

# Comenzando a obtener los datos de nuestros sujetos
```{r}
##Linea Base (Grupo 0)

# obtenemos toda la base de datos de epilepsia
data_cruda<-MASS::epil
data_cruda
# Nos quedamos solo con los datos de aquellos con tratamiento de progabide excluyendo a aquellos con trt=="placebo"
sujetos_progabide<-subset(data_cruda, trt == "progabide")
sujetos_progabide$y
# como cada sujeto tiene 4 medidas en y, obtengo diviendo entre 4 la cantidad de sujetos.
num_sujetos<-(length(sujetos_progabide$trt)/4)
# obtener la linea base con identificador de paciente
linea_base_cruda <- data.frame(sujetos_progabide$base,sujetos_progabide$age,sujetos_progabide$subject)
# eliminamos los valores repetidos (ya que como se tiene 4 medidas pero la base es la misma e igual el identificador del sujeto)
linea_base_cruda[duplicated(linea_base_cruda), ]
#Con esto cambio los nombres.
grupo0 <- rename(linea_base_cruda %>% distinct, base = "sujetos_progabide.base" , edad="sujetos_progabide.age",sujeto= "sujetos_progabide.subject")
```


```{r}
##Grupo 1,2,3,4 (las semanas)

sujetos_progabide1 <- subset(sujetos_progabide, period == "1")
grupo1 <- data.frame(sujetos_progabide1$y,sujetos_progabide1$age,sujetos_progabide1$subject)
grupo1 <- rename(grupo1 %>% distinct, N_epilepsias1 = "sujetos_progabide1.y" , edad="sujetos_progabide1.age",sujeto= "sujetos_progabide1.subject")

sujetos_progabide2 <- subset(sujetos_progabide, period == "2")
grupo2 <- data.frame(sujetos_progabide2$y,sujetos_progabide2$age,sujetos_progabide2$subject)
grupo2 <- rename(grupo2 %>% distinct, N_epilepsias2 = "sujetos_progabide2.y" , edad="sujetos_progabide2.age",sujeto= "sujetos_progabide2.subject")

sujetos_progabide3 <- subset(sujetos_progabide, period == "3")
grupo3 <- data.frame(sujetos_progabide3$y,sujetos_progabide3$age,sujetos_progabide3$subject)
grupo3 <- rename(grupo3 %>% distinct, N_epilepsias3 = "sujetos_progabide3.y" , edad="sujetos_progabide3.age",sujeto= "sujetos_progabide3.subject")

sujetos_progabide4 <- subset(sujetos_progabide, period == "4")
grupo4 <- data.frame(sujetos_progabide4$y,sujetos_progabide4$age,sujetos_progabide4$subject)
grupo4 <- rename(grupo4 %>% distinct, N_epilepsias4 = "sujetos_progabide4.y" , edad="sujetos_progabide4.age",sujeto= "sujetos_progabide4.subject")
grupos <- data.frame(grupo0,grupo1$N_epilepsias1,grupo2$N_epilepsias2,grupo3$N_epilepsias3,grupo4$N_epilepsias4)
#Podria quitar los sujetos y edad y dejar uno solo y asi no repetir variables en el data frame de grupos, pero individualmente como data.frame si es necesario para identificar.
```

```{r}
#Pruebas estadisticas de linea base para observar que tipo de distribucion es
shapiro.test(grupo0$base)
#puedo rechazar la hipotesis nula
#no es normal nuestra distribucion

hist(log10(grupo0$base)) #no es recomendable para ver mejor si hay outlayers.
hist(grupo0$base)
plot(x = grupo0$base)
#Q-Q plot para verificar si es normal
qqnorm(grupo0$base)
qqline(grupo0$base, col="purple", lw=2)
#jugando con los datos para entender mejor lo que hago
p<-ggplot(grupo0, aes(x=base, y=edad)) + 
  geom_dotplot(binaxis='y')
p

descdist(grupo0$base) # se ve como una distribucion beta
p <- seq(0,80, length=100) #### aqui hab?ia un igual (=) pero yo lo cambie por la flechita (<-) atte Pau
qqplot(grupo0$base, dbeta(p, 100, 100))
#se puede colocar el parametro boot, Ajustala a la beta. Hace Q-Qplot     
#el segundo dataset debe ser con la que compararare
#si son muy raras, estadistica descriptiva.
#distribucion empirica ponderada
```


#Observando estadistica descriptiva de grupos de las semanas:

```{r}
summary(grupos)
```



# PRUEBAS DE NORMALIDAD
```{r}
## Grupo 1
shapiro.test(grupo1$N_epilepsias1) # se rechaza hipotesis nula, no es normal la distribucion 
hist(grupo1$N_epilepsias1)
descdist(grupo1$N_epilepsias1) # se ve que tambien es beta

## Grupo 2
shapiro.test(grupo2$N_epilepsias2) # se rechaza hipotesis nula, no es normal la distribucion 
hist(grupo2$N_epilepsias2)
descdist(grupo2$N_epilepsias2)# se ve que tambien es beta

## Grupo 3
shapiro.test(grupo3$N_epilepsias3) # se rechaza hipotesis nula, no es normal la distribucion 
hist(grupo3$N_epilepsias3)
descdist(grupo3$N_epilepsias3)# se ve que tambien es beta

## Grupo 4
shapiro.test(grupo4$N_epilepsias4) # se rechaza hipetesis nula, no es normal la distribucion 
hist(grupo4$N_epilepsias4)
descdist(grupo4$N_epilepsias4)# se ve que tambien es beta
```

```{r}
# Para ver si estan bien codificados los datos:
str(grupo0) # todos son enteros, se ve bien
str(grupo1)
str(grupo2)
str(grupo3)
str(grupo4)
str(grupos)
```



#Todos son betas, por ende podemos utilizar... ANOVA? Friedman? kruskal?

# Hago unos boxplot a ver:

```{r}
b0 <- ggplot(grupo0, aes(x=sujeto, y=base)) + 
  geom_boxplot()
b0
b1 <- ggplot(grupo1, aes(x=sujeto, y=N_epilepsias1)) + 
  geom_boxplot()
b1
b2 <- ggplot(grupo2, aes(x=sujeto, y=N_epilepsias2)) + 
  geom_boxplot()
b2
b3 <- ggplot(grupo3, aes(x=sujeto, y=N_epilepsias3)) + 
  geom_boxplot()
b3
b4 <- ggplot(grupo4, aes(x=sujeto, y=N_epilepsias4)) + 
  geom_boxplot()
b4

base_entre_4<- (grupo0$base)/4

suma_total_trt<-grupo1$N_epilepsias1+grupo2$N_epilepsias2+grupo3$N_epilepsias3+grupo4$N_epilepsias4

boxplot(base_entre_4,grupo1$N_epilepsias1,grupo2$N_epilepsias2,grupo3$N_epilepsias3,grupo4$N_epilepsias4)

boxplot(grupo0$base,suma_total_trt)

boxplot(data_cruda$y~data_cruda$period)

```

# Quitar el outlier
```{r}
#buscamos dode esta el outlier, sujeto 49
which(sujetos_progabide$subject == 49)


#borramos las filas 81, 82, 83, 84 y asignamos nuevo nombre

sujetos_progabide_out <- sujetos_progabide[-c(81, 82, 83, 84),]
sujetos_progabide_out
```
# Boxplots comparados y con colorcitos
```{r}
#dataframe con los datos necesarios

boxplots.df <- data.frame(sujetos_progabide_out$y, sujetos_progabide_out$period)

#cambiando nombres

colnames(boxplots.df)
names(boxplots.df)[names(boxplots.df) == "sujetos_progabide_out.y"] <- "crisis"
names(boxplots.df)[names(boxplots.df) == "sujetos_progabide_out.period"] <- "periodo"

# añadiendo la base/4 como periodo 0 
period0 <- data.frame(crisis= sujetos_progabide_out$base/4, periodo = 0)

boxplots.df <- rbind(boxplots.df, period0)
boxplots.df

# convirtiendo a factor el periodo

boxplots.df$periodo <- as.factor(boxplots.df$periodo)

# ploteo

boxplots <- ggplot(boxplots.df, aes(x= periodo, y= crisis, color=periodo)) +
  geom_boxplot()
boxplots
```

# Utilizando Kruskal Willis
```{r}
#Analisis estadistico utilizando el carlos walace

kruskal.test(formula,x=grupo1$N_epilepsias1, g=grupo0$base)

kruskal.test(formula,x=grupo2$N_epilepsias2, g=grupo0$base)

kruskal.test(formula,x=grupo3$N_epilepsias3, g=grupo0$base)

kruskal.test(formula,x=grupo4$N_epilepsias4, g=grupo0$base)

kruskal.test(formula,x=suma_total_trt, g=grupo0$base)
```

# Gráfica de cómo va avanzando cada paciente

sujetos <- sujetos_progabide$subject
sujetos.df <- data.frame(sujetos, sujetos_progabide$y, sujetos_progabide$period)

names(sujetos.df)[names(sujetos.df) == "sujetos_progabide.y"] <- "crisis"
names(sujetos.df)[names(sujetos.df) == "sujetos_progabide.period"] <- "periodo"

periodo0 <- data.frame(sujetos = sujetos_progabide$subject, crisis= sujetos_progabide$base, periodo = 0 )

sujetos.df <- rbind(sujetos.df, periodo0)
sujetos.df$periodo <- as.factor(sujetos.df$periodo)
sujetos.df$sujetos <- as.factor(sujetos.df$sujetos)
View(sujetos.df)

individual <- ggplot(sujetos.df, aes(x = periodo, y = crisis, color = sujetos, group = sujetos)) + geom_point() + geom_line()
individual


# Realizamos lo mismo con el grupo control

# Nos quedamos solo con los datos de aquellos con placebo 
sujetos_placebo<-subset(data_cruda, trt == "placebo")
sujetos_placebo$y
# como cada sujeto tiene 4 medidas en y, obtengo diviendo entre 4 la cantidad de sujetos.
num_sujetospl<-(length(sujetos_placebo$trt)/4)
# obtener la linea base con identificador de paciente
linea_base_p <- data.frame(sujetos_placebo$base,sujetos_placebo$age,sujetos_placebo$subject)
# eliminamos los valores repetidos (ya que como se tiene 4 medidas pero la base es la misma e igual el identificador del sujeto)
linea_base_p[duplicated(linea_base_p), ]
#Con esto cambio los nombres.
control0 <- rename(linea_base_p %>% distinct, base = "sujetos_placebo.base" , edad="sujetos_placebo.age",sujeto= "sujetos_placebo.subject")

## Control 1,2,3,4 (las semanas)

sujetos_placebo1 <- subset(sujetos_placebo, period == "1")
control1 <- data.frame(sujetos_placebo1$y,sujetos_placebo1$age,sujetos_placebo1$subject)
control1 <- rename(control1 %>% distinct, crisis1 = "sujetos_placebo1.y" , edad="sujetos_placebo1.age",sujeto= "sujetos_placebo1.subject")

sujetos_placebo2 <- subset(sujetos_placebo, period == "2")
control2 <- data.frame(sujetos_placebo2$y,sujetos_placebo2$age,sujetos_placebo2$subject)
control2 <- rename(control2 %>% distinct, crisis2 = "sujetos_placebo2.y" , edad="sujetos_placebo2.age",sujeto= "sujetos_placebo2.subject")

sujetos_placebo3 <- subset(sujetos_placebo, period == "3")
control3 <- data.frame(sujetos_placebo3$y,sujetos_placebo3$age,sujetos_placebo3$subject)
control3 <- rename(control3 %>% distinct, crisis3 = "sujetos_placebo3.y" , edad="sujetos_placebo3.age",sujeto= "sujetos_placebo3.subject")

sujetos_placebo4 <- subset(sujetos_placebo, period == "4")
control4 <- data.frame(sujetos_placebo4$y,sujetos_placebo4$age,sujetos_placebo4$subject)
control4 <- rename(control4 %>% distinct, crisis4 = "sujetos_placebo4.y" , edad="sujetos_placebo4.age",sujeto= "sujetos_placebo4.subject")
controles <- data.frame(control0,control1,control2,control3,control4)


## Ver las distribuciones en cada control (boxplots)

boxplotsc.df <- data.frame(sujetos_placebo$y, sujetos_placebo$period)
colnames(boxplotsc.df)

names(boxplotsc.df)[names(boxplotsc.df) == "sujetos_placebo.y"] <- "crisis"
names(boxplotsc.df)[names(boxplotsc.df) == "sujetos_placebo.period"] <- "periodo"

p0 <- data.frame(crisis= sujetos_placebo$base / 4, periodo = 0)

boxplotsc.df <- rbind(boxplotsc.df, p0)
boxplotsc.df$periodo <- as.factor(boxplotsc.df$periodo)

bpcontrol <- ggplot(boxplotsc.df, aes(x= periodo, y= crisis, color=periodo)) +
  geom_boxplot()
bpcontrol


# Gráfica de cómo va avanzando cada control

sujetos.control <- data.frame(sujetos_placebo$subject, sujetos_placebo$y, sujetos_placebo$period)

names(sujetos.control)[names(sujetos.control) == "sujetos_placebo.y"] <- "crisis"
names(sujetos.control)[names(sujetos.control) == "sujetos_placebo.period"] <- "periodo"
names(sujetos.control)[names(sujetos.control) == "sujetos_placebo.subject"] <- "sujetos"

p0.c <- data.frame(sujetos = sujetos_placebo$subject, crisis= sujetos_placebo$base, periodo = 0 )

sujetos.control <- rbind(sujetos.control, p0.c)
sujetos.control$periodo <- as.factor(sujetos.control$periodo)
sujetos.control$sujetos <- as.factor(sujetos.control$sujetos)
View(sujetos.control)

indcontrol <- ggplot(sujetos.control, aes(x = periodo, y = crisis, color = sujetos, group = sujetos)) + geom_point() + geom_line()
indcontrol

## Pruebas estadisticas de linea base para observar que tipo de distribucion es

shapiro.test(control0$base)
#puedo rechazar la hipotesis nula
#no es normal nuestra distribución
hist(log10(control0$base)) #no es recomendable para ver mejor si hay outlayers.
hist(control0$base)
#Q-Q plot para verificar si es normal
qqnorm(control0$base)
qqline(control0$base, col="purple", lw=2) #se ve que no es normal

library(fitdistrplus)
descdist(control0$base) # también se ve como una distribución beta


## Observando estadistica descriptiva de grupos de las semanas:

summary(controles) #tendríamos que cambiar los sujetos a factores

controles$sujeto <- as.factor(controles$sujeto)
controles$sujeto.1 <- as.factor(controles$sujeto.1)
controles$sujeto.2 <- as.factor(controles$sujeto.2)
controles$sujeto.3 <- as.factor(controles$sujeto.3)
controles$sujeto.4 <- as.factor(controles$sujeto.4)

summary(controles) # listo :)

# PRUEBAS DE NORMALIDAD

## Control 1
shapiro.test(control1$crisis1) # se rechaza hipótesis nula, no es normal la distribución 
hist(control1$crisis1)
library(fitdistrplus)
descdist(control1$crisis1) # se ve que también es beta

## Control 2
shapiro.test(control2$crisis2) # se rechaza hipótesis nula, no es normal la distribución 
hist(control2$crisis2)
library(fitdistrplus)
descdist(control2$crisis2)# se ve que también es beta

## Control 3
shapiro.test(control3$crisis3) # se rechaza hipótesis nula, no es normal la distribución 
hist(control3$crisis3)
library(fitdistrplus)
descdist(control3$crisis3)# se ve que también es beta

## Control 4
shapiro.test(control4$crisis4) # se rechaza hipótesis nula, no es normal la distribución 
hist(control4$crisis4)
library(fitdistrplus)
descdist(control4$crisis4)# se ve que también es beta





















  
