---
title: " Proyecto equipo 4 "
output: html_notebook
---

```{r}
#Librerias
library(pwr)
library(ggplot2)
library(dplyr)
library(fitdistrplus)
library(modeest)
```



# Comenzando a obtener los datos de nuestros sujetos:
```{r}
##Linea Base

# obtenemos toda la base de datos de epilepsia
data_cruda<-MASS::epil
data_cruda

# Quitar los outliers

#buscamos donde estan los outliers, sujetos 49 y 25
data_cruda
which(data_cruda$subject == 25)

#borramos las filas correspondientes y asignamos nuevo nombre

data_cruda_out <- data_cruda[-c(97, 98, 99, 100, 193, 194, 195, 196),]
data_cruda_out

# data cocinada (línea base/4)
Data_cocinada <- data.frame(data_cruda$subject, data_cruda$base /4, data_cruda$y, data_cruda$period, data_cruda$trt)
#cambiando nombres
colnames(Data_cocinada)
names(Data_cocinada)[names(Data_cocinada) == "data_cruda.subject"] <- "sujeto"
names(Data_cocinada)[names(Data_cocinada) == "data_cruda.base.4"] <- "base"
names(Data_cocinada)[names(Data_cocinada) == "data_cruda.y"] <- "crisis"
names(Data_cocinada)[names(Data_cocinada) == "data_cruda.period"] <- "periodo"
names(Data_cocinada)[names(Data_cocinada) == "data_cruda.trt"] <- "tratamiento"
Data_cocinada
# data sin linea base
Data_condimentada <- data.frame(Data_cocinada$sujeto, Data_cocinada$crisis, Data_cocinada$periodo, Data_cocinada$tratamiento)
names(Data_condimentada)[names(Data_condimentada) == "Data_cocinada.sujeto"] <- "sujeto"
names(Data_condimentada)[names(Data_condimentada) == "Data_cocinada.crisis"] <- "crisis"
names(Data_condimentada)[names(Data_condimentada) == "Data_cocinada.periodo"] <- "periodo"
names(Data_condimentada)[names(Data_condimentada) == "Data_cocinada.tratamiento"] <- "tratamiento"
colnames(Data_condimentada)
# Poniendo la línea base como periodo 0
period0 <- data.frame(sujeto= Data_cocinada$sujeto, crisis= Data_cocinada$base, periodo = 0, tratamiento = Data_cocinada$tratamiento)

period0$periodo <- as.factor(period0$periodo)
period0_ND <- period0 %>% distinct

Data_condimentada <- rbind(Data_condimentada, period0_ND)

Data_condimentada
Data_condimentada <- Data_condimentada[with(Data_condimentada, order(Data_condimentada$sujeto)), ]
#Con este data.frame ya podemos hacer nuestras pruebas de hipotesis.
```

# Base de datos de porcentaje de diferencia:
```{r}
# Añadiendo el porcetaje de diferencia
Porcentaje.diferencia <- (Data_cocinada$crisis / Data_cocinada$base)*100
Porcentaje.diferencia 
Porcentaje.df <- cbind(Data_cocinada, Porcentaje.diferencia)
names(Porcentaje.df)[names(Porcentaje.df) == "Porcentaje.diferencia"] <- "porcentaje"
names(Porcentaje.df)[names(Porcentaje.df) == "data_cruda.trt"] <- "tratamiento"
Porcentaje.df$periodo <- as.factor(Porcentaje.df$periodo)
```

# Boxplots:
```{r}
boxplots_cruda <- ggplot(Data_condimentada, aes(x= periodo, y= crisis, fill= tratamiento)) +
  geom_boxplot() +
  ggtitle("Número de crisis epilépticas de los sujetos por cada periodo")
boxplots_cruda

boxplots_porcentaje <- ggplot(Porcentaje.df, aes(x= periodo, y= porcentaje, fill= tratamiento)) +
  geom_boxplot() +
ggtitle("Porcentaje de crisis epilépticas por periodo con respecto a línea base")
boxplots_porcentaje
```

# Prueba wilcoxon datos crudos
```{r}
#Aqui no diferencia a los periodos, por lo que  comparamos entre placebo y progabide sin la base ya que la linea base sirve para comparar.
pairwise.wilcox.test(x=as.numeric(Data_cocinada$crisis), g=as.factor(Data_cocinada$tratamiento),
                     p.adjust.method = "bonferroni",paired = FALSE)

#A1 de Alan.doc
Data_wilcoxon <- Data_condimentada

#Periodo + tratamiento en una sola columna
Data_wilcoxon$Vector1<-paste0(Data_wilcoxon$tratamiento, Data_wilcoxon$periodo)

pairwise.wilcox.test(x=as.numeric(Data_wilcoxon$crisis), g=as.factor(Data_wilcoxon$Vector1),
                     p.adjust.method = "bonferroni",paired = FALSE, exact=FALSE)

#optimización
i <- 0
while (i < 5) {
  pl <- paste0("placebo",i)
  j <- 0
  while (j < 5) {
    pr <- paste0("progabide",j)
    w <- wilcox.test(Data_wilcoxon$crisis[Data_wilcoxon$Vector1 ==pl], Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == pr], paired = FALSE, alternative = "greater",exact=FALSE)
    j <- j+1
    print(paste("comparando",pl,"con",pr))
    print(w)
  }
  j <- 0
  while (j < 5) {
    pr <- paste0("placebo",j)
    w <- wilcox.test(Data_wilcoxon$crisis[Data_wilcoxon$Vector1 ==pl], Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == pr], paired = FALSE, alternative = "greater",exact=FALSE)
    j <- j+1
    print(paste("comparando",pl,"con",pr))
    print(w)
  }
  j <- 0
  pr2 <- paste0("progabide",i)
  while (j < 5) {
    print("entro")
    pr <- paste0("progabide",j)
    w <- wilcox.test(Data_wilcoxon$crisis[Data_wilcoxon$Vector1 ==pr2], Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == pr], paired = FALSE, alternative = "greater",exact=FALSE)
    j <- j+1
    print(paste("comparando",pr2,"con",pr))
    print(w)
  }
    i<- i+1
}

```
# Wilcoxon Uno por uno, placebo vs progabide
```{r}
wilcox.test(Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "placebo0"], Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "progabide0"], paired = FALSE, alternative = "greater")
wilcox.test(Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "placebo0"], Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "progabide1"], paired = FALSE, alternative = "greater")
wilcox.test(Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "placebo0"], Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "progabide2"], paired = FALSE, alternative = "greater")
wilcox.test(Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "placebo0"], Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "progabide3"], paired = FALSE, alternative = "greater")
wilcox.test(Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "placebo0"], Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "progabide4"], paired = FALSE, alternative = "greater")

wilcox.test(Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "placebo1"], Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "progabide0"], paired = FALSE, alternative = "greater")
wilcox.test(Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "placebo1"], Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "progabide1"], paired = FALSE, alternative = "greater")
wilcox.test(Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "placebo1"], Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "progabide2"], paired = FALSE, alternative = "greater")
wilcox.test(Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "placebo1"], Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "progabide3"], paired = FALSE, alternative = "greater")
wilcox.test(Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "placebo1"], Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "progabide4"], paired = FALSE, alternative = "greater")

wilcox.test(Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "placebo2"], Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "progabide0"], paired = FALSE, alternative = "greater")
wilcox.test(Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "placebo2"], Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "progabide1"], paired = FALSE, alternative = "greater")
wilcox.test(Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "placebo2"], Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "progabide2"], paired = FALSE, alternative = "greater")
wilcox.test(Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "placebo2"], Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "progabide3"], paired = FALSE, alternative = "greater")
wilcox.test(Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "placebo2"], Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "progabide4"], paired = FALSE, alternative = "greater")

wilcox.test(Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "placebo3"], Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "progabide0"], paired = FALSE, alternative = "greater")
wilcox.test(Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "placebo3"], Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "progabide1"], paired = FALSE, alternative = "greater")
wilcox.test(Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "placebo3"], Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "progabide2"], paired = FALSE, alternative = "greater")
wilcox.test(Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "placebo3"], Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "progabide3"], paired = FALSE, alternative = "greater")
wilcox.test(Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "placebo3"], Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "progabide4"], paired = FALSE, alternative = "greater")

wilcox.test(Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "placebo4"], Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "progabide0"], paired = FALSE, alternative = "greater")
wilcox.test(Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "placebo4"], Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "progabide1"], paired = FALSE, alternative = "greater")
wilcox.test(Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "placebo4"], Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "progabide2"], paired = FALSE, alternative = "greater")
wilcox.test(Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "placebo4"], Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "progabide3"], paired = FALSE, alternative = "greater")
wilcox.test(Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "placebo4"], Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "progabide4"], paired = FALSE, alternative = "greater")


wilcox.test(Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "progabide0"], Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "progabide1"], paired = FALSE, alternative = "greater")
wilcox.test(Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "progabide0"], Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "progabide2"], paired = FALSE, alternative = "greater")
wilcox.test(Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "progabide0"], Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "progabide3"], paired = FALSE, alternative = "greater")
wilcox.test(Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "progabide0"], Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "progabide4"], paired = FALSE, alternative = "greater")

wilcox.test(Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "progabide1"], Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "progabide4"], paired = FALSE, alternative = "greater")
wilcox.test(Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "progabide1"], Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "progabide2"], paired = FALSE, alternative = "greater")
wilcox.test(Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "progabide1"], Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "progabide3"], paired = FALSE, alternative = "greater")

wilcox.test(Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "progabide2"], Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "progabide4"], paired = FALSE, alternative = "greater")
wilcox.test(Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "progabide2"], Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "progabide3"], paired = FALSE, alternative = "greater")

wilcox.test(Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "progabide3"], Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "progabide4"], paired = FALSE, alternative = "greater")

wilcox.test(Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "placebo0"], Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "placebo1"], paired = FALSE, alternative = "greater")
wilcox.test(Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "placebo0"], Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "placebo2"], paired = FALSE, alternative = "greater")
wilcox.test(Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "placebo0"], Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "placebo3"], paired = FALSE, alternative = "greater")
wilcox.test(Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "placebo0"], Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "placebo4"], paired = FALSE, alternative = "greater")

wilcox.test(Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "placebo1"], Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "placebo2"], paired = FALSE, alternative = "greater")
wilcox.test(Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "placebo1"], Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "placebo3"], paired = FALSE, alternative = "greater")
wilcox.test(Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "placebo1"], Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "placebo4"], paired = FALSE, alternative = "greater")

wilcox.test(Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "placebo2"], Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "placebo3"], paired = FALSE, alternative = "greater")
wilcox.test(Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "placebo2"], Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "placebo4"], paired = FALSE, alternative = "greater")

wilcox.test(Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "placebo3"], Data_wilcoxon$crisis[Data_wilcoxon$Vector1 == "placebo4"], paired = FALSE, alternative = "greater")
```

# Análisis  de estadística descriptiva
```{r}
#install.packages("modeest")
sujetos_placebo<-subset(data_cruda, trt == "placebo")
sujetos_progabide<-subset(data_cruda, trt == "progabide")

## Control 1,2,3,4 (las semanas)

sujetos_placebo1 <- subset(sujetos_placebo, period == "1")
control1 <- data.frame(sujetos_placebo1$y,sujetos_placebo1$age,sujetos_placebo1$subject)
control1 <- rename(control1 %>% distinct, crisis1 = "sujetos_placebo1.y" , edad="sujetos_placebo1.age",sujeto= "sujetos_placebo1.subject")

sujetos_placebo2 <- subset(sujetos_placebo, period == "2")
control2 <- data.frame(sujetos_placebo2$y,sujetos_placebo2$age,sujetos_placebo2$subject)
control2 <- rename(control2 %>% distinct, crisis2 = "sujetos_placebo2.y" , edad="sujetos_placebo2.age",sujeto= "sujetos_placebo2.subject")

sujetos_placebo3 <- subset(sujetos_placebo, period == "3")
control3 <- data.frame(sujetos_placebo3$y,sujetos_placebo3$age,sujetos_placebo3$subject)
control3 <- rename(control3 %>% distinct, crisis3 = "sujetos_placebo3.y" , edad="sujetos_placebo3.age",sujeto= "sujetos_placebo3.subject")

sujetos_placebo4 <- subset(sujetos_placebo, period == "4")
control4 <- data.frame(sujetos_placebo4$y,sujetos_placebo4$age,sujetos_placebo4$subject)
control4 <- rename(control4 %>% distinct, crisis4 = "sujetos_placebo4.y" , edad="sujetos_placebo4.age",sujeto= "sujetos_placebo4.subject")
controles <- data.frame(control0,control1,control2,control3,control4)
```
# Número de pacientes 
```{r}
sujetos_placebo$subject # 28 pacientes
sujetos_progabide$subject # 30 pacientes
```
# Media:
```{r}
media.edpl <- mean(sujetos_placebo$age)
media.edpr <- mean(sujetos_progabide$age)
```
# Mediana:
```{r}
mediana.edpl <- median(sujetos_placebo$age)
mediana.edpr <- median(sujetos_progabide$age)
```
# Moda:
```{r}
moda.edpl <- mfv(sujetos_placebo$age)
moda.edpr <- mfv(sujetos_progabide$age)
```
# Desviación Estandar
```{r}
sd.edpl <- sd(sujetos_placebo$age)
sd.edpr <- sd(sujetos_progabide$age)
```
# Varianza
```{r}
var.edpl <- var(sujetos_placebo$age)
var.edpr <- var(sujetos_progabide$age)
```
# cuantiles
```{r}
q.edpl <- quantile(sujetos_placebo$age)
q.edpr <- quantile(sujetos_progabide$age)
```
# IQR
```{r}
iqr.edpl <- IQR(sujetos_placebo$age)
iqr.edpr <- IQR(sujetos_progabide$age)
```
# covarianza
```{r}
cv.edpl <- sd.edpl/media.edpl
cv.edpr <- sd.edpr/media.edpr
```
# Rango
```{r}
ran.edpl <- range(sujetos_placebo$age)
ran.edpr <- range(sujetos_progabide$age)
```
# Pruebas de Normalidad
```{r}

## Control 1
shapiro.test(control1$crisis1) # se rechaza hipótesis nula, no es normal la distribución 
hist(control1$crisis1)
library(fitdistrplus)
descdist(control1$crisis1) # se ve que también es beta
qqnorm(control1$base)
qqline(control1$base, col="purple", lw=2) #se ve que no es normal

## Control 2
shapiro.test(control2$crisis2) # se rechaza hipótesis nula, no es normal la distribución 
hist(control2$crisis2)
library(fitdistrplus)
descdist(control2$crisis2)# se ve que también es beta

## Control 3
shapiro.test(control3$crisis3) # se rechaza hipótesis nula, no es normal la distribución 
hist(control3$crisis3)
library(fitdistrplus)
descdist(control3$crisis3)# se ve que también es beta

## Control 4
shapiro.test(control4$crisis4) # se rechaza hipótesis nula, no es normal la distribución 
hist(control4$crisis4)
library(fitdistrplus)
descdist(control4$crisis4)# se ve que también es beta
```

#Codigos que no se muy bien:

# Gráfica de cómo va avanzando cada control
```{r}

sujetos.control <- data.frame(sujetos_placebo$subject, sujetos_placebo$y, sujetos_placebo$period)

names(sujetos.control)[names(sujetos.control) == "sujetos_placebo.y"] <- "crisis"
names(sujetos.control)[names(sujetos.control) == "sujetos_placebo.period"] <- "periodo"
names(sujetos.control)[names(sujetos.control) == "sujetos_placebo.subject"] <- "sujetos"

p0.c <- data.frame(sujetos = sujetos_placebo$subject, crisis= sujetos_placebo$base, periodo = 0 )

sujetos.control <- rbind(sujetos.control, p0.c)
sujetos.control$periodo <- as.factor(sujetos.control$periodo)
sujetos.control$sujetos <- as.factor(sujetos.control$sujetos)
View(sujetos.control)

indcontrol <- ggplot(sujetos.control, aes(x = periodo, y = crisis, color = sujetos, group = sujetos)) + geom_point() + geom_line()
indcontrol

```

# Gráfica de cómo va avanzando cada paciente

```{r}
sujetos <- sujetos_progabide$subject
sujetos.df <- data.frame(sujetos, sujetos_progabide$y, sujetos_progabide$period)

names(sujetos.df)[names(sujetos.df) == "sujetos_progabide.y"] <- "crisis"
names(sujetos.df)[names(sujetos.df) == "sujetos_progabide.period"] <- "periodo"

periodo0 <- data.frame(sujetos = sujetos_progabide$subject, crisis= sujetos_progabide$base, periodo = 0 )

sujetos.df <- rbind(sujetos.df, periodo0)
sujetos.df$periodo <- as.factor(sujetos.df$periodo)
sujetos.df$sujetos <- as.factor(sujetos.df$sujetos)

individual <- ggplot(sujetos.df, aes(x = periodo, y = crisis, color = sujetos, group = sujetos)) + geom_point() + geom_line()
individual

```

## Ver las distribuciones en cada control (boxplots)
```{r}
boxplotsc.df <- data.frame(sujetos_placebo$y, sujetos_placebo$period)
colnames(boxplotsc.df)

names(boxplotsc.df)[names(boxplotsc.df) == "sujetos_placebo.y"] <- "crisis"
names(boxplotsc.df)[names(boxplotsc.df) == "sujetos_placebo.period"] <- "periodo"

p0 <- data.frame(crisis= sujetos_placebo$base / 4, periodo = 0)

boxplotsc.df <- rbind(boxplotsc.df, p0)
boxplotsc.df$periodo <- as.factor(boxplotsc.df$periodo)

bpcontrol <- ggplot(boxplotsc.df, aes(x= periodo, y= crisis, color=periodo)) +
  geom_boxplot()
bpcontrol

```

# Codigo que no sé --> 
```{r}
summary(controles) #tendríamos que cambiar los sujetos a factores

controles$sujeto <- as.factor(controles$sujeto)
controles$sujeto.1 <- as.factor(controles$sujeto.1)
controles$sujeto.2 <- as.factor(controles$sujeto.2)
controles$sujeto.3 <- as.factor(controles$sujeto.3)
controles$sujeto.4 <- as.factor(controles$sujeto.4)

summary(controles) # listo :)
```





























  
